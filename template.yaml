AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  serverless-file-processing
  
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Runtime: nodejs12.x
    CodeUri: dist/
    Timeout: 3
  
Parameters:
  ApplicationName:
    Type: String
    Default: serverless-file-processing
  ApiStageName:
    Type: String
    Default: dev
  UpdateProcessorRoleArn:
    Type: String
    Default: arn:aws:iam::361728023653:role/serverless-file-processing-table-item-role
  TargetTableName:
    Type: String
    Default: serverless-file-processing-table
  EnableSQS:
    Type: String
    AllowedValues: [true, false]
    Default: true

Resources:

  LookupTable:    
    Type: TODO
    
  FileBucket:
    Type: AWS::S3::Bucket
    DependsOn: UnprocessedFileQueue
    Properties: 
      BucketName: !Sub ${ApplicationName}-file-bucket
      NotificationConfiguration:
        QueueConfigurations:
        - Event: 's3:ObjectCreated:*'
          Queue: !GetAtt UnprocessedFileQueue.Arn

  UnprocessedFileQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${ApplicationName}-unprocessed-file-queue
      ReceiveMessageWaitTimeSeconds: 20
      VisibilityTimeout: 360

  UnprocessedFileQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    DependsOn: UnprocessedFileQueue
    Properties: 
      Queues: 
        - !Ref UnprocessedFileQueue
      PolicyDocument: 
        Statement: 
          - 
            Action: 
              - "SQS:SendMessage" 
            Effect: "Allow"
            Resource: !GetAtt UnprocessedFileQueue.Arn
            Principal:  
              Service: s3.amazonaws.com

  UnprocessedUpdateQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${ApplicationName}-unprocessed-update-queue
      ReceiveMessageWaitTimeSeconds: 20
      VisibilityTimeout: 60

  FileProcessorFunction:
    Type: AWS::Serverless::Function
    DependsOn: 
      - UnprocessedFileQueue
      - FileBucket
      - UnprocessedUpdateQueue
    Properties:
      FunctionName: !Sub ${ApplicationName}-file-processor-function
      Handler: fileProcessorLambda.handle
      Timeout: 60
      Environment:
        Variables:
          UNPROCESSED_UPDATE_QUEUE_URL: !Ref UnprocessedUpdateQueue
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt UnprocessedUpdateQueue.QueueName
        - S3ReadPolicy:
            BucketName: !Ref FileBucket
      Events:
        UnprocessedFileEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt UnprocessedFileQueue.Arn
            BatchSize: 10
            Enabled: !Ref EnableSQS

  UpdateProcessorFunction:
    Type: AWS::Serverless::Function
    DependsOn:
      - UnprocessedUpdateQueue
      # TODO The DynamoDb table too
    Properties:
      FunctionName: !Sub ${ApplicationName}-update-processor-function
      Handler: updateProcessorLambda.handle
      Role: !Ref UpdateProcessorRoleArn
      Timeout: 10
      Environment:
        Variables:
          TARGET_TABLE_NAME: !Ref TargetTableName
      Events:
        UnprocessedUpdateEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt UnprocessedUpdateQueue.Arn
            BatchSize: 10
            Enabled: !Ref EnableSQS

