AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  serverless-file-processing

  SAM Template for serverless-file-processing
  
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Runtime: nodejs12.x
    CodeUri: dist/
    Timeout: 3
  
Parameters:
  ApplicationName:
    Type: String
    Default: serverless-file-processing
  ApiStageName:
    Type: String
    Default: dev

Resources:

  UnprocessedFileQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${ApplicationName}-unprocessed-file-queue

  UnprocessedFileQueuePolicy:
    Type: AWS::SQS::QueuePolicy
    Properties: 
      Queues: 
        - !Ref UnprocessedFileQueue
      PolicyDocument: 
        Statement: 
          - 
            Action: 
              - "SQS:SendMessage" 
            Effect: "Allow"
            Resource: !GetAtt UnprocessedFileQueue.Arn
            Principal:  
              Service: s3.amazonaws.com

  FileBucket:
    Type: AWS::S3::Bucket
    Properties: 
      BucketName: !Sub ${ApplicationName}-file-bucket
      NotificationConfiguration:
        QueueConfigurations:
        - Event: 's3:ObjectCreated:*'
          Queue: !GetAtt UnprocessedFileQueue.Arn

  FileProcessingFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ${ApplicationName}-file-processing-function
      Handler: lambda.handle
      # Environment:
      #   Variables:
      #     RESPONSE_TOPIC: !Ref TargetFunctionResponseTopic
      # Policies:
      #   - SNSPublishMessagePolicy:
      #       TopicName: !GetAtt TargetFunctionResponseTopic.TopicName
      Events:
        UnprocessedFileEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt UnprocessedFileQueue.Arn
            BatchSize: 10
            Enabled: true

